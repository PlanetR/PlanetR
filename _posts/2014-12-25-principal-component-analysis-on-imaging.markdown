---
title: "Principal Component Analysis on Imaging"
kind: article
created_at: 2014-12-25 12:26:00 UTC
author: Alstatr
categories: 
tags: 
layout: post
---
<div dir="ltr" style="text-align: left;" trbidi="on">Ever wonder what's the mathematics behind face recognition on most gadgets like digital camera and smartphones? Well for most part it has something to do with statistics. One statistical tool that is capable of doing such feature is the Principal Component Analysis (PCA). In this post, however, we will not do (sorry to disappoint you) face recognition as we reserve this for future post while I'm still doing research on it. Instead, we go through its basic concept and use it for data reduction on spectral bands of the image using R. <br /><br /><h3>Let's view it mathematically</h3>Consider a line $L$ in a parametric form described as a set of all vectors $k\cdot\mathbf{u}+\mathbf{v}$ parameterized by $k\in \mathbb{R}$, where $\mathbf{v}$ is a vector orthogonal to a <a href="http://en.wikipedia.org/wiki/Unit_vector" target = "_blank">normalized vector</a> $\mathbf{u}$. Below is the graphical equivalent of the statement: <br /><div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://1.bp.blogspot.com/-oIhTE11jN2M/VJal1FsTndI/AAAAAAAACCU/BQOhihmxKbg/s1600/Screen%2BShot%2B2014-12-21%2Bat%2B6.49.01%2BPM.png" height="217" width="320" /></div><a name='more'></a>So if given a point $\mathbf{x}=[x_1,x_2]^T$, the orthogonal projection of this point on the line $L$ is given by $(\mathbf{u}^T\mathbf{x})\mathbf{u}+\mathbf{v}$. Graphically, we mean <br /><div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://1.bp.blogspot.com/-wXHcQqUbIg4/VJuuXbZlUKI/AAAAAAAACGc/ythfr395Z5s/s1600/Screen%2BShot%2B2014-12-25%2Bat%2B2.25.12%2BPM.png" height="267" width="320" /></div><center><input onclick="window.open('https://gist.github.com/alstat/b392b73d73fdb1b000ee', '_blank')" type="button" value="LaTeX Code" /></center><br />$Proj$ is the projection of the point $\mathbf{x}$ on the line, where the position of it is defined by the scalar $\mathbf{u}^{T}\mathbf{x}$. Therefore, if we consider $\mathbf{X}=[X_1, X_2]^T$ be a random vector, then the random variable $Y=\mathbf{u}^T\mathbf{X}$ describes the variability of the data on the direction of the normalized vector $\mathbf{u}$. So that $Y$ is a linear combination of $X_i, i=1,2$. <i>The principal component analysis identifies a linear combinations of the original variables $\mathbf{X}$ that contain most of the information, in the sense of variability, contained in the data. The general assumption is that useful information is proportional to the variability. PCA is used for data dimensionality reduction and for interpretation of data. (Ref 1. Bajorski, 2012)</i><br /><br />To better understand this, consider two dimensional data set, below is the plot of it along with two lines ($L_1$ and $L_2$) that are orthogonal to each other: <br /><div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://2.bp.blogspot.com/-nvaBbrlToDY/VJgUgBbsnlI/AAAAAAAACDk/qnJuoCWGFms/s1600/Screen%2BShot%2B2014-12-22%2Bat%2B8.53.11%2BPM.png" height="400" width="313" /></div>If we project the points orthogonally to both lines we have,  <br /><div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://4.bp.blogspot.com/-W7A5s6Syx3E/VJgYtd1b16I/AAAAAAAACDw/cW9CTB81xwk/s1600/Screen%2BShot%2B2014-12-22%2Bat%2B9.11.24%2BPM.png" height="400" width="312" /></div><center><input onclick="window.open('https://gist.github.com/alstat/ec5bfa3342b95029b9b7', '_blank')" type="button" value="LaTeX Code" /></center><br />So that if normalized vector $\mathbf{u}_1$ defines the direction of $L_1$, then the variability of the points on $L_1$ is described by the random variable $Y_1=\mathbf{u}_1^T\mathbf{X}$. Also if $\mathbf{u}_2$ is a normalized vector that defines the direction of $L_2$, then the variability of the points on this line is described by the random variable $Y_2=\mathbf{u}_2^T\mathbf{X}$. The first principal component is one with maximum variability. So in this case, we can see that $Y_2$ is more variable than $Y_1$, since the points projected on $L_2$ are more dispersed than in $L_1$. In practice, however, the linear combinations $Y_i = \mathbf{u}_i^T\mathbf{X}, i=1,2,\cdots,p$ is maximized sequentially so that $Y_1$ is the linear combination of the first principal component, $Y_2$ is the linear combination of the second principal component, and so on. Further, the estimate of the direction vector $\mathbf{u}$ is simply the normalized eigenvector $\mathbf{e}$ of the variance-covariance matrix $\mathbf{\Sigma}$ of the original variable $\mathbf{X}$. And the variability explained by the principal component is the corresponding eigenvalue $\lambda$. For more details on theory of PCA refer to (Bajorski, 2012) at Reference 1 below.<br /><br />As promised we will do dimensionality reduction using PCA. We will use the Airborne Visible/Infrared Imaging Spectrometer (AVIRIS) data from (Barjorski, 2012), you can use other locations of AVIRIS data that can be downloaded <a href="http://aviris.jpl.nasa.gov/data/get_aviris_data.html" target="_blank">here</a>. However, since for most cases the AVIRIS data contains thousands of bands so for simplicity we will stick with the data given in (Bajorski, 2012) as it was cleaned reducing to 152 bands only.<br /><br /><h3 style="text-align: left;">What is spectral bands?</h3><div>In imaging, spectral bands refer to the third dimension of the image usually denoted as $\lambda$. For example, RGB image contains red, green and blue bands as shown below along with the first two dimensions $x$ and $y$ that define the resolution of the image.</div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-a3bgtZdbDxM/VJhC1rosXLI/AAAAAAAACEA/bmrOtplXFJk/s1600/Screen%2BShot%2B2014-12-23%2Bat%2B12.11.08%2BAM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-a3bgtZdbDxM/VJhC1rosXLI/AAAAAAAACEA/bmrOtplXFJk/s1600/Screen%2BShot%2B2014-12-23%2Bat%2B12.11.08%2BAM.png" height="200" width="400" /></a></div><center><input onclick="window.open('https://gist.github.com/alstat/4c333c590cbead3fa067', '_blank')" type="button" value="LaTeX Code" /></center><br /><div>These are few of the bands that are visible to our eyes, there are other bands that are not visible to us like infrared, and many other in <a href="http://en.wikipedia.org/wiki/Electromagnetic_spectrum" target = "_blank">electromagnetic spectrum</a>. That is why in most cases AVIRIS data contains huge number of bands each captures different characteristics of the image. Below is the proper description of the data.<br /><br /><h3 style="text-align: left;">Data</h3>The Airborne Visible/Infrared Imaging Spectrometer (AVIRIS), is a sensor collecting spectral radiance in the range of wavelengths from 400 to 2500 nm. It has been flown on various aircraft platforms, and many images of the Earthâ€™s surface are available. A 100 by 100 pixel AVIRIS image of an urban area in Rochester, NY, near the Lake Ontario shoreline is shown below. The scene has a wide range of natural and man-made material including a mixture of commercial/warehouse and residential neighborhoods, which adds a wide range of spectral diversity. Prior to processing, invalid bands (due to atmospheric water absorption) were removed, reducing the overall dimensionality to 152 bands. This image has been used in Bajorski et al. (2004) and Bajorski (2011a, 2011b). The first 152 values in the AVIRIS Data represent the spectral radiance values (a spectral curve) for the top left pixel. This is followed by spectral curves of the pixels in the first row, followed by the next row, and so on. (Ref. 1 Bajorski, 2012)</div><br />To load the data, run the following code: <br /><br /><script src="https://gist.github.com/alstat/5ca5842c5ffe3173e1fb.js"></script><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-SSWlkwxoNI8/VJkMm5gCzmI/AAAAAAAACEQ/g1GWBcTRDvQ/s1600/Rplot.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-SSWlkwxoNI8/VJkMm5gCzmI/AAAAAAAACEQ/g1GWBcTRDvQ/s1600/Rplot.png" height="255" width="400" /></a></div>Above code uses EBImage package, and can be installed from my <a href="http://alstatr.blogspot.com/2014/09/r-image-analysis-using-ebimage.html" target="_blank">previous post</a>. <br /><br /><h3>Why do we need to reduce the dimension of the data?</h3>Before we jump in to our analysis, in case you may ask why? Well sometimes it's just difficult to do analysis on high dimensional data, especially on interpreting it. This is because there are dimensions that aren't significant (like redundancy) which adds to our problem on the analysis. So in order to deal with this, we remove those nuisance dimension and deal with the significant one.<br /><br />To perform PCA in R, we use the function <code>princomp</code> as seen below:<br /><br /><script src="https://gist.github.com/alstat/bec19685dc2a9cb63ce3.js"></script>The structure of <code>princomp</code> consist of a list shown above, we will give description to selected outputs. Others can be found in the documentation of the function by executing <code>?princomp</code>. <br /><ul><li><code>sdev</code> - standard deviation, the square root of the eigenvalues $\lambda$ of the variance-covariance matrix $\mathbf{\Sigma}$ of the data, <code>dat.mat</code>;</li><li><code>loadings</code> - eigenvectors $\mathbf{e}$ of the variance-covariance matrix $\mathbf{\Sigma}$ of the data, <code>dat.mat</code>;</li><li><code>scores</code> - the principal component scores.</li></ul>Recall that the objective of PCA is to find for a linear combination $Y=\mathbf{u}^T\mathbf{X}$ that will maximize the variance $Var(Y)$. So that from the output, the estimate of the components of $\mathbf{u}$ is the entries of the <code>loadings</code> which is a matrix of eigenvectors, where the columns corresponds to the eigenvectors of the sequence of principal components, that is if the first principal component is given by $Y_1=\mathbf{u}_1^T\mathbf{X}$, then the estimate of $\mathbf{u}_1$ which is $\mathbf{e}_1$ (eigenvector) is the set of coefficients obtained from the first column of the <code>loadings</code>. The explained variability of the first principal component is the square of the first standard deviation <code>sdev</code>, the explained variability of the second principal component is the square of the second standard deviation <code>sdev</code>, and so on. Now let's interpret the loadings (coefficients) of the first three principal components. Below is the plot of this, <div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://1.bp.blogspot.com/-hbbxvQnCJ4c/VJlq34XF3wI/AAAAAAAACEg/5vMv_Tgvx3M/s1600/Rplot01.png" /></div><script src="https://gist.github.com/alstat/a1ebd7d3ae1661569170.js"></script>Base above, the coefficients of the first principal component (PC1) are almost all negative. A closer look, the variability in this principal component is mainly explained by the weighted average of radiance of the spectral bands 35 to 100. Analogously, PC2 mainly represents the variability of the weighted average of radiance of spectral bands 1 to 34. And further, the fluctuation of the coefficients of PC3 makes it difficult to tell on which bands greatly contribute on its variability. Aside from examining the loadings, another way to see the impact of the PCs is through the <i>impact plot</i> where the <i>impact curve</i> $\sqrt{\lambda_j}\mathbf{e}_j$ are plotted, I want you to explore that. <br /><br />Moving on, let's investigate the percent of variability in $X_i$ explained by the $j$th principal component, below is the formula of this, \begin{equation}\nonumber \frac{\lambda_j\cdot e_{ij}^2}{s_{ii}}, \end{equation} where $s_{ii}$ is the estimated variance of $X_i$. So that below is the percent of explained variability in $X_i$ of the first three principal components including the cumulative percent variability (sum of PC1, PC2, and PC3), <div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://1.bp.blogspot.com/-OtlrmJFo9J4/VJl9NwPX6gI/AAAAAAAACEw/Nm-jnl3jUR4/s1600/Rplot03.png" /></div><script src="https://gist.github.com/alstat/d8a599e8dd802a009cae.js"></script>For the variability of the first 33 bands, PC2 takes on about 90 percent of the explained variability as seen in the above plot. And still have great contribution further to 102 to 152 bands. On the other hand, from bands 37 to 100, PC1 explains almost all the variability with PC2 and PC3 explain 0 to 1 percent only. The sum of the percentage of explained variability of these principal components is indicated as orange line in the above plot, which is the cumulative percent variability.<br /><br />To wrap up this section, here is the percentage of the explained variability of the first 10 PCs.<br /><br /><div class="datagrid"><table><thead><tr><th>PC1</th><th>PC2</th><th>PC3</th><th>PC4</th><th>PC5</th><th>PC6</th><th>PC7</th><th>PC8</th><th>PC9</th><th>PC10</th></tr></thead><tfoot><tr><td colspan="10" style="text-align: center;"><div id="paging"><i>Table 1: Variability Explained by the First Ten Principal Components for the AVIRIS data.</i></div></td></tr></tfoot><tbody><tr><td>82.057</td><td>17.176</td><td>0.320</td><td>0.182</td><td>0.094</td><td>0.065</td><td>0.037</td><td>0.029</td><td>0.014</td><td>0.005</td></tr></tbody></table></div><br />Above variability were obtained by noting that the variability explained by the principal component is simply the eigenvalue (square of the <code>sdev</code>) of the variance-covariance matrix $\mathbf{\Sigma}$ of the original variable $\mathbf{X}$, hence the percentage of variability explained by the $j$th PC is equal to its corresponding eigenvalue $\lambda_j$ divided by the overall variability which is the sum of the eigenvalues, $\sum_{j=1}^{p}\lambda_j$, as we see in the following code,<br /><br /><script src="https://gist.github.com/alstat/a19e345d766c64eb88ad.js"></script><h3>Stopping Rules</h3>Given the list of percentage of variability explained by the PCs in Table 1, how many principal components should we take into account that would best represent the variability of the original data? To answer that, we introduce the following stopping rules that will guide us on deciding the number of PCs: <br /><ol><li>Scree plot;</li><li>Simple fare-share;</li><li>Broken-stick; and,</li><li>Relative broken-stick.</li></ol>The scree plot is the plot of the variability of the PCs, that is the plot of the eigenvalues. Where we look for an elbow or sudden drop of the eigenvalues on the plot, hence for our example we have <div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://3.bp.blogspot.com/-oLLybyPjcrs/VJpfHe3_VDI/AAAAAAAACFE/XRiKQMJ3eeQ/s1600/Rplot04.png" /></div><script src="https://gist.github.com/alstat/80133cd378bd3ff9ea02.js"></script>Therefore, we need return the first two principal components based on the elbow shape. However, if the eigenvalues differ by order of magnitude, it is recommended to use the logarithmic scale which is illustrated below, <div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://2.bp.blogspot.com/-xI-GIozT-H0/VJpgVb6mWUI/AAAAAAAACFM/4g-hTjZ6c3w/s1600/Rplot05.png" /></div>Unfortunately, sometimes it won't work as we can see here, it's just difficult to determine where the elbow is. The succeeding discussions on the last three stopping rules are based on (Bajorski, 2012). The <i>simple fair-share</i> stopping rule identifies the largest $k$ such that $\lambda_k$ is larger than its fair share, that is larger than $(\lambda_1+\lambda_2+\cdots+\lambda_p)/p$. To illustrate this, consider the following:<br /><br /><script src="https://gist.github.com/alstat/a1d446cea1dea3f9878e.js"></script>Thus, we need to stop at second principal component.<br /><br />If one was concerned that the above method produces too many principal components, a <i>broken-stick rule</i> could be used. The rule is that it identifies the principal components with largest $k$ such that $\lambda_j/(\lambda_1+\lambda_2+\cdots +\lambda_p)&gt;a_j$, for all $j\leq k$, where \begin{equation}\nonumber a_j = \frac{1}{p}\sum_{i=j}^{p}\frac{1}{i},\quad j =1,\cdots, p. \end{equation} Let's try it,<br /><br /><script src="https://gist.github.com/alstat/160b9d116e94a55bb0b2.js"></script>Above result coincides with the first two stopping rule. The draw back of simple fair-share and broken-stick rules is that it do not work well when the eigenvalues differ by orders of magnitude. In such case, we then use the <i>relative broken-stick</i> rule, where we analyze $\lambda_j$ as the first eigenvalue in the set $\lambda_j\geq \lambda_{j+1}\geq\cdots\geq\lambda_{p}$, where $j &lt; p$. The dimensionality $k$ is chosen as the largest value such that $\lambda_j/(\lambda_j+\cdots +\lambda_p)&gt;b_j$, for all $j\leq k$, where  \begin{equation}\nonumber b_j = \frac{1}{p-j+1}\sum_{i=1}^{p-j+1}\frac{1}{i}. \end{equation} Applying this to the data we have, <div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://4.bp.blogspot.com/-kXD9Xf9TFY8/VJpmzZrz_kI/AAAAAAAACFc/FQ6xEELDIGs/s1600/Rplot06.png" /></div><script src="https://gist.github.com/alstat/02733c62f0cd338d54dc.js"></script>According to the numerical output, the first 34 principal components are enough to represent the variability of the original data. <br /><br /><h3>Principal Component Scores</h3>The principal component scores is the resulting new data set obtained from the linear combinations $Y_j=\mathbf{e}_j(\mathbf{x}-\bar{\mathbf{x}}), j = 1,\cdots, p$. So that if we use the first three stopping rules, then below is the scores (in image) of PC1 and PC2, <div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://3.bp.blogspot.com/-rpL8t7rXqFI/VJpsrk1I1XI/AAAAAAAACFs/cVFnfhQ0nRk/s1600/Rplot07.png" height="255" width="400" /></div><script src="https://gist.github.com/alstat/acc2d9cfc047332a9a54.js"></script>If we base on the relative broken-stick rule then we return the first 34 PCs, and below is the corresponding scores (in image). <table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-KtZHTeSHD1o/VJptlxjGAWI/AAAAAAAACF0/3jKTdRGH9iQ/s1600/Rplot08.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://1.bp.blogspot.com/-KtZHTeSHD1o/VJptlxjGAWI/AAAAAAAACF0/3jKTdRGH9iQ/s400/Rplot08.png" height="255" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Click on the image to zoom in.</td></tr></tbody></table><h3>Residual Analysis</h3>Of course when doing PCA there are errors to be considered unless one would return all the PCs, but that would not make any sense because why would someone apply PCA when you still take into account all the dimensions? An overview of the errors in PCA without going through the theory is that, the overall error is simply the excluded variability explained by the $k$th to $p$th principal components, $k&gt;j$. <br /><br /><h3 style="text-align: left;">Reference</h3><div><ol style="text-align: left;"><li><a href="http://www.amazon.com/Statistics-Imaging-Optics-Photonics-Bajorski/dp/0470509457" target="_blank">Bajorski, P. (2012). <i>Statistics for Imaging, Optics, and Photonics</i>. John Wiley &amp; Sons, Inc.</a></li></ol><h3>Download PDF Version</h3><center><input onclick="window.open('https://github.com/alstat/Analysis-with-Programming/raw/master/2014/R/Principal%20Component%20Analysis%20on%20Imaging/Principal%20Component%20Analysis%20on%20Imaging.pdf', '_blank')" type="button" value="Click here to download" /></center></div></div><div class="author">
  <img src="" style="width: 96px; height: 96;">
  <span style="position: absolute; padding: 32px 15px;">
    <i>Original post by <a href="http://twitter.com/">Alstatr</a> - check out <a href="http://alstatr.blogspot.com/">Analysis with Programming</a></i>
  </span>
</div>
